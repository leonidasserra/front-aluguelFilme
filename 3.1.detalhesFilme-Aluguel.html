<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Detalhes do Filme</title>
    <!-- Vincula o arquivo JavaScript externo
    <script src="detalhes.js" defer></script>  -->
</head>



<!-- Sidebar -->
<div class="sidebar">
    <ul>
        <a href="3.telaInicial.html">Home</a>
        <br>
        <a href="5.pessoas.html">Ver Clientes</a>
        <br>
        <a href="2.cadastro.html">Novo Cliente</a>
        <br>
        <a href="6.novoFilme.html">Novo Filme</a>
        <br>
        <a href="javascript:history.back()">Voltar</a>
        <br>
        <a href="1.login.html" id="exit-btn">Sair</a>
    </ul>
</div><!-- fechamento adicionado da div.sidebar -->

<body>
<div class="main-content-filmesDet">
    <form action="3.telaInicial.html">
                <br>
        <div class="movie-details-title">
            <h1>Detalhes do filme</h1>
        </div>
        <div class="details">
            
            <div id="inner-movieDetails">
           <table>
                <thead>
                    <tr>
                        <td>Código</td>
                        <td>Título(Mais Detalhes)</td>
                        <td>Gênero</td>
                        <td>Ano</td>
                        <td>Estoque</td>
                        <td>Ações</td>
                    </tr>
                </thead>
                <tbody id="corpo_tabela_filmes_3">
                    <tr>
                        <!-- <td>0</td>
                        <td><a href="3.1.2.detalhesFilme.html">Senhor dos Anéis: A Sociedade do Anel</a></td>
                        <td>Fantasia</td>
                        <td>2001</td>
                        <td>12</td>
                        <td>  </td> -->
                    </tr>
                </tbody>
            </table>
        </div> 
        <h2>Empréstimos Relacionados</h2>
            <table>
                <thead>
                    <tr>
                        <td>Código</td>
                        <td>Data de inicio</td>
                        <td>Data de Devolução</td>
                        <td>Valor</td>
                        <td>Status</td>
                        <td>Cliente</td>
                        <td>Ações</td>
                    </tr>
                </thead>
                <tbody id="lista-emprestimos-relacionados">
                    <tr>
                        <!-- <td>0</td>
                        <td>11/08/2025</a></td>
                        <td>10/09/2025</td>
                        <td>39,50</td>
                        <td>Ativo</td>
                        <td></td>
                        <td><button type="button" class="add-btn">Concluir</button></td> -->
                    </tr>
                </tbody>
            </table>


        </div>
        <!-- <div class="div-back-btn-filmedet">
            <button type="submit" class="back-btn">Voltar</button>
        </div> fechamento adicionado da div do botão -->

    </form>
            <nav class="pagination" aria-label="Navegação de páginas">
            <ul>
                <li><a href="?page=1" class="active">1</a></li>
                <li><a href="?page=2">2</a></li>
                <li><a href="?page=3">3</a></li>
                <li><a href="?page=2">Próximo</a></li>
            </ul>
        </nav>
</div>
</body>
<script>
const urlParams = new URLSearchParams(window.location.search);
const idUrl = urlParams.get("id");
console.log("id_filme:",idUrl);

    fetch(`http://localhost:8080/filme/buscar/${idUrl}`)
        .then((response) => response.json())
        .then((data) => {
            console.log(data);

            // Nesse caso a api retorna um objeto e não uma lista como na home
            const filme = data;

            const linha = document.createElement("tr");

            const celulaId = document.createElement("td");
            celulaId.textContent = filme.id;
            linha.appendChild(celulaId);

            const celulaTitle = document.createElement("td");
            const linkTitle = document.createElement("a");
            linkTitle.textContent = filme.title;
            linkTitle.href = `3.1.2.detalhesFilme.html?id=${encodeURIComponent(filme.id)}`;
            celulaTitle.appendChild(linkTitle);

            linha.appendChild(celulaTitle);

            const celulaGenero = document.createElement("td");
            celulaGenero.textContent = filme.genero;
            linha.appendChild(celulaGenero);

            const celulaAno = document.createElement("td");
            celulaAno.textContent = filme.ano;
            linha.appendChild(celulaAno);

            const celulaEstoque = document.createElement("td");
            celulaEstoque.textContent = filme.quantidadeEstoque;
            linha.appendChild(celulaEstoque);

            // const celulaExcludeBtn = document.createElement("td");
            // const excludeBtn = document.createElement("button");
            // excludeBtn.type = 'button';
            // excludeBtn.classList.add('exclude-btn');    // Adiciona a classe "exclude-btn"

            // // 4. Criar o elemento <i> (o ícone)
            // const iconeLixeira = document.createElement('i');

            // // 5. Adicionar as classes do Font Awesome ao ícone
            // iconeLixeira.classList.add('fa-solid', 'fa-trash'); // Adiciona as classes "fa-solid" e "fa-trash"

            // 6. Montar a estrutura (aninhamento)
            // Coloca o ícone <i> DENTRO do botão <button>
            // excludeBtn.appendChild(iconeLixeira);
            // excludeBtn.value = filme.id;
            // celulaExcludeBtn.appendChild(excludeBtn);
            // linha.appendChild(celulaExcludeBtn);

            const dadosTabela = document.getElementById("corpo_tabela_filmes_3");
            dadosTabela.appendChild(linha);
        })
        .catch(error => console.error('Erro ao buscar filmes:', error));



//================Impl Aluguel associado===================================

// ... (código anterior)

const corpoTabelaAluguel = document.getElementById("lista-emprestimos-relacionados");

fetch(`http://localhost:8080/aluguel/buscafilme/${idUrl}`)
    .then((response) => response.json())
    .then((data) => {
        console.log(data);
        const alugueis = data;
        alugueis.forEach((aluguel) => {
            const linha = document.createElement("tr");
            const celulaId = document.createElement("td");
            celulaId.textContent = aluguel.id;
            linha.appendChild(celulaId);

            const celuladataAluguel = document.createElement("td");
            celuladataAluguel.textContent = aluguel.dataAluguel;
            console.log(aluguel.dataAluguel);
            linha.appendChild(celuladataAluguel);

            const celulaDataDevolucao = document.createElement("td");
            celulaDataDevolucao.textContent = aluguel.devolucaoPrevista;
            linha.appendChild(celulaDataDevolucao);

            const celulaPreco = document.createElement("td");
            celulaPreco.textContent = aluguel.valorAluguel;
            linha.appendChild(celulaPreco);

            const celulaStatus = document.createElement("td");
            celulaStatus.textContent = aluguel.status;
            linha.appendChild(celulaStatus);

            const celulaPessoa = document.createElement("td");
            const idPessoaAluguel = aluguel.pessoa.id;
            fetch(`http://localhost:8080/pessoa/buscar/${idPessoaAluguel}`)
                .then((response) => response.json())
                .then((data) => {
                    const nomePessoaAluguel = data.name;
                    console.log(nomePessoaAluguel);
                    celulaPessoa.textContent = nomePessoaAluguel;
                    linha.appendChild(celulaPessoa);

                    const celulaBtn = document.createElement("td");
                    const btnConcluirEmprestimo = document.createElement("button");
                    btnConcluirEmprestimo.classList.add("add-btn");
                    btnConcluirEmprestimo.innerText = "Concluir";
                    btnConcluirEmprestimo.setAttribute('type', 'button');
                    btnConcluirEmprestimo.value = aluguel.id;
                    celulaBtn.appendChild(btnConcluirEmprestimo);
                    linha.appendChild(celulaBtn);

                    btnConcluirEmprestimo.addEventListener('click', () => {
                        const idAluguelConcluido = btnConcluirEmprestimo.value;
                        console.log(idAluguelConcluido);
                        
                        // Chamando a função para concluir o empréstimo
                        concluirEmprestimo(idAluguelConcluido, celulaStatus);
                    });
                });

            corpoTabelaAluguel.appendChild(linha);
        });
    })
    .catch(error => console.error('Erro ao buscar alugueis:', error));


// Função de conclusão do empréstimo reestruturada
async function concluirEmprestimo(idAluguel, celulaStatus) {
    try {
        const response = await fetch(`http://localhost:8080/aluguel/finalizar/${idAluguel}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`Erro na requisição: ${response.status} ${response.statusText}`);
        }

        console.log(`Empréstimo ${idAluguel} concluído com sucesso.`);
        // Atualiza o status na tabela após o sucesso da requisição
        celulaStatus.textContent = 'Finalizado';
        window.location.reload(); // Recarrega a página para atualizar a tabela
    } catch (error) {
        console.error('Houve um problema ao concluir o empréstimo:', error);
    }
}
</script>
</html>
