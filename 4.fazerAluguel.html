<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <meta charset="UTF-8" />
    <title>Confirmação</title>
</head>
<body>


    <!-- Sidebar -->
<div class="sidebar">
    <ul>
        <a href="3.telaInicial.html">Home</a>
        <br>
        <a href="5.pessoas.html">Ver Clientes</a>
        <br>
        <a href="2.cadastro.html">Novo Cliente</a>
        <br>
        <a href="6.novoFilme.html">Novo Filme</a>
        <br>
        <a href="javascript:history.back()">Voltar</a>
        <br>
        <a href="1.login.html" id="exit-btn">Sair</a>
    </ul>
</div>

    <!-- Formulário de Confirmação -->
    <form method="get">    
        <div class="rent-title">    
            <h1>Confirmação do Empréstimo</h1>
        </div>  

        <div class="rent-main-content">
            <table>
                    <thead>
                        <tr>
                            <td>Código</td>
                            <td>Título</td>
                            <td>Gênero</td>
                            <td>Ano</td>
                            <td>Estoque</td>
                            <td>Excluir</td>
                        </tr>
                    </thead>
                    <tbody id="corpo_tabela_filmes_2">
                        <!-- <tr>
                            <td>0</td>
                            <td><a href="3.1.detalhesFilme-Aluguel.html">Senhor dos Anéis: A Sociedade do Anel</a></td>
                            <td>Fantasia</td>
                            <td>2001</td>
                            <td>12</td>
                            <td><button type="button" class="exclude-btn"><i class="fa-solid fa-trash"></i></button></td>
                        </tr> -->
                    </tbody>
                </table>

            <br><br>
            
            <div class="make-rent">
                <div class="section-signup-rent" id="section-signup-rent">
                    <!-- <label for="pessoa">Empréstimo para: </label>
                    <input type="text" id="pessoaAluguel" name="pessoaAluguel" required> -->
                
                  <br><br>
                <table id="table_busca_pessoas_alugueis"></table>
            </div>
                <br><br>

                <div class="div-rent-btn">
                    <button type="submit" class="float-btn">Confirmar</button>
                </div>
            </div>    
        </div>
    </form>

    <!-- Janela de Confirmação -->
    <div class="overlay" id="overlay">
    <div class="confirm-box" id="confirmBox">
        <p>Você tem certeza?</p>
        <div class="inner-confirm-box">
            <button id="btnSim">Sim</button>
            <button id="btnNao">Não</button>
        </div>    
    </div>
    </div>
    <!-- Botão de Configurações -->
    <div>
        <br><br>
        <form action="configuracoes.html" method="get">
            <button type="submit" class="config-btn">Configurações</button>
        </form>
    </div>

    <script>
    const idsSelecionados = JSON.parse(sessionStorage.getItem('filmesSelecionados') || '[]'); 
    // ALTERAÇÃO: adicionado fallback '[]' para evitar erro se a chave não existir.

    const idsTratados = [];
    idsSelecionados.forEach(id => {
        idsTratados.push(parseInt(id));
    });

    idsTratados.forEach(id => {
        fetch(`http://localhost:8080/filme/buscar/${id}`)
            .then((response) => response.json())
            .then((data) => {
                const filme = data;

                const linha = document.createElement("tr");

                const celulaId = document.createElement("td");
                celulaId.textContent = filme.id;
                linha.appendChild(celulaId);

                const celulaTitle = document.createElement("td");
                const linkTitle = document.createElement("a");
                linkTitle.textContent = filme.title;
                linkTitle.href = `3.1.detalhesFilme-Aluguel.html?id=${encodeURIComponent(filme.id)}`;
                celulaTitle.appendChild(linkTitle);
                linha.appendChild(celulaTitle);

                const celulaGenero = document.createElement("td");
                celulaGenero.textContent = filme.genero;
                linha.appendChild(celulaGenero);

                const celulaAno = document.createElement("td");
                celulaAno.textContent = filme.ano;
                linha.appendChild(celulaAno);

                const celulaEstoque = document.createElement("td");
                celulaEstoque.textContent = filme.quantidadeEstoque;
                linha.appendChild(celulaEstoque);

                const celulaExcludeBtn = document.createElement("td");
                const excludeBtn = document.createElement("button");
                excludeBtn.type = 'button';
                // (deixei o id repetido como estava; recomendável usar só classe)
                excludeBtn.id = 'exc-button';
                excludeBtn.classList.add('exclude-btn');
                const iconeLixeira = document.createElement('i');
                iconeLixeira.classList.add('fa-solid', 'fa-trash');
                excludeBtn.appendChild(iconeLixeira);
                excludeBtn.value = filme.id;
                celulaExcludeBtn.appendChild(excludeBtn);
                linha.appendChild(celulaExcludeBtn);

                const dadosTabela = document.getElementById("corpo_tabela_filmes_2");
                dadosTabela.appendChild(linha);
            })
            .catch(error => console.error('Erro ao buscar filmes:', error));
    });

    const corpoTabela = document.getElementById("corpo_tabela_filmes_2");
    corpoTabela.addEventListener('click', function(e) {
        // (mantive sua lógica; recomendável usar closest('button') e closest('tr'))
        if (e.target.matches('i')) {
            const button = e.target.closest('button');
            const row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }
    });

    const container = document.getElementById("section-signup-rent");

    const inputPessoaAlugar = document.createElement('input');
    inputPessoaAlugar.type = 'text';
    inputPessoaAlugar.id = 'pessoaAluguel';
    inputPessoaAlugar.name = 'pessoaAluguel';
    inputPessoaAlugar.required = true;
    const label = document.createElement('label');
    label.htmlFor = 'pessoaAluguel';
    label.textContent = 'Empréstimo para: ';

    container.appendChild(label);
    container.appendChild(inputPessoaAlugar);

    // ====== TABELA DE PESSOAS ======

    // ALTERAÇÃO: criar o THEAD uma única vez, fora do fetch.
    const table = document.getElementById("table_busca_pessoas_alugueis");
    const tableHead = document.createElement('thead');
    const tableRow = document.createElement('tr');

    const thId = document.createElement('th');
    thId.textContent = "Código";
    tableRow.appendChild(thId);    

    const thNome = document.createElement('th');
    thNome.textContent = "Nome";
    tableRow.appendChild(thNome);        

    const thCpf = document.createElement('th');
    thCpf.textContent = "CPF";    
    tableRow.appendChild(thCpf);        

    const thActions = document.createElement('th');
    thActions.textContent = "Ações";
    tableRow.appendChild(thActions);        

    tableHead.appendChild(tableRow);
    table.appendChild(tableHead);

    // ALTERAÇÃO: criar UM ÚNICO <tbody> e anexar à tabela.
    const corpoTabelaPessoas = document.createElement("tbody");
    corpoTabelaPessoas.id = 'tbody_busca_pessoas'; // id para limpeza posterior
    table.appendChild(corpoTabelaPessoas); // <== efetivamente anexa o tbody à tabela

    // ALTERAÇÃO: função para buscar pessoas e preencher a tabela (em vez de buscar imediatamente com input vazio).
    function buscarPessoas(query) {
        // ALTERAÇÃO: limpar o corpo antes de nova busca
        corpoTabelaPessoas.replaceChildren();

        // Estado "carregando"
        const carregando = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 4;
        td.textContent = 'Carregando...';
        carregando.appendChild(td);
        corpoTabelaPessoas.appendChild(carregando);

        fetch(`http://localhost:8080/pessoa/buscar?name=${encodeURIComponent(query)}`)
            .then((response) => response.json())
            .then((data) => {
                // limpar estado "carregando"
                corpoTabelaPessoas.replaceChildren();

                const pessoas = data || [];
                if (pessoas.length === 0) {
                    const vazio = document.createElement('tr');
                    const tdVazio = document.createElement('td');
                    tdVazio.colSpan = 4;
                    tdVazio.textContent = 'Nenhum resultado';
                    vazio.appendChild(tdVazio);
                    corpoTabelaPessoas.appendChild(vazio);
                    return;
                }

                pessoas.forEach(pessoa => {
                    const linha = document.createElement("tr");

                    const celulaId = document.createElement("td");
                    celulaId.textContent = pessoa.id;
                    linha.appendChild(celulaId);

                    const celulaName = document.createElement("td");
                    celulaName.textContent = pessoa.name;
                    linha.appendChild(celulaName);

                    const celulaCpf = document.createElement("td");
                    celulaCpf.textContent = pessoa.cpf;
                    linha.appendChild(celulaCpf);

                    const celulaRadio = document.createElement("td");
                    const radio = document.createElement("input");
                    radio.type = 'radio';
                    radio.name = 'pessoaID'; // radios no mesmo grupo
                    radio.className = 'radio';
                    radio.value = pessoa.id;
                    celulaRadio.appendChild(radio);
                    //================================================================
                    
                    //FALTA SALVAR A PESSOA EM SESSION STORAGE E FINALIZAR O ALUGUEL
                    
                    //================================================================
                    linha.appendChild(celulaRadio);

                    corpoTabelaPessoas.appendChild(linha);
                });
            })
            .catch((err) => {
                corpoTabelaPessoas.replaceChildren();
                const erro = document.createElement('tr');
                const tdErro = document.createElement('td');
                tdErro.colSpan = 4;
                tdErro.textContent = 'Erro ao buscar pessoas';
                erro.appendChild(tdErro);
                corpoTabelaPessoas.appendChild(erro);
                console.error(err);
            });
    }

    // Debouce simples para evitar busca a cada tecla
    let debounceTimer = null;
    inputPessoaAlugar.addEventListener('input', () => {
        const q = inputPessoaAlugar.value.trim();
        // mínimo de 2 caracteres para buscar
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            if (q.length >= 2) {
                buscarPessoas(q);
            } else {
                // limpa resultados se apagar o termo
                corpoTabelaPessoas.replaceChildren();
            }
        }, 300);
    });

    //Ao voltar via histórico (bfcache), limpar SOMENTE o tbody (mantém thead).
    window.addEventListener('pageshow', (e) => {
        if (e.persisted) {
            document.getElementById('tbody_busca_pessoas')?.replaceChildren();
        }
    });
    </script>
</body>
</html>
