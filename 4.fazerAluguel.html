<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <meta charset="UTF-8" />
    <title>Confirmação</title>
</head>
<body>


    <!-- Sidebar -->
<div class="sidebar">
    <ul>
        <a href="3.telaInicial.html">Home</a>
        <br>
        <a href="5.pessoas.html">Ver Clientes</a>
        <br>
        <a href="2.cadastro.html">Novo Cliente</a>
        <br>
        <a href="6.novoFilme.html">Novo Filme</a>
        <br>
        <a href="javascript:history.back()">Voltar</a>
        <br>
        <a href="1.login.html" id="exit-btn">Sair</a>
    </ul>
</div>

    <!-- Formulário de Confirmação -->
    <form method="get">    
        <div class="rent-title">    
            <h1>Confirmação do Empréstimo</h1>
        </div>  

        <div class="rent-main-content">
            <table>
                    <thead>
                        <tr>
                            <td>Código</td>
                            <td>Título</td>
                            <td>Gênero</td>
                            <td>Ano</td>
                            <td>Estoque</td>
                            <td>Excluir</td>
                        </tr>
                    </thead>
                    <tbody id="corpo_tabela_filmes_2">
                        <!-- <tr>
                            <td>0</td>
                            <td><a href="3.1.detalhesFilme-Aluguel.html">Senhor dos Anéis: A Sociedade do Anel</a></td>
                            <td>Fantasia</td>
                            <td>2001</td>
                            <td>12</td>
                            <td><button type="button" class="exclude-btn"><i class="fa-solid fa-trash"></i></button></td>
                        </tr> -->
                    </tbody>
                </table>

            <br><br>
            
            <div class="make-rent">
                <div class="section-signup-rent" id="section-signup-rent">
                    <!-- <label for="pessoa">Empréstimo para: </label>
                    <input type="text" id="pessoaAluguel" name="pessoaAluguel" required> -->
                </div>
                  <!-- <br> -->
                <table id="table_busca_pessoas_alugueis"></table>
            </div>
                <br><br>

                <div class="div-rent-btn">
                    <button type="button"  id="confirm-rent-btn" class="float-btn">Confirmar</button>
                </div>
            </div>    
        </div>
    </form>

    <!-- Janela de Confirmação -->
    <div class="overlay" id="overlay">
    <div class="confirm-box" id="confirmBox">
        <p>Você tem certeza?</p>
        <div class="inner-confirm-box">
            <button id="btnSim">Sim</button>
            <button id="btnNao">Não</button>
        </div>    
    </div>
    </div>
    <!-- Botão de Configurações -->
    <div>
        <br><br>
        <form action="configuracoes.html" method="get">
            <button type="submit" class="config-btn">Configurações</button>
        </form>
    </div>

    <script>
    const idsSelecionados = JSON.parse(sessionStorage.getItem('filmesSelecionados') || '[]'); 
    // ALTERAÇÃO: adicionado fallback '[]' para evitar erro se a chave não existir.

    let idsTratados = [];
    idsSelecionados.forEach(id => {
        idsTratados.push(parseInt(id));
    });

    idsTratados.forEach(id => {
        fetch(`http://localhost:8080/filme/buscar/${id}`)
            .then((response) => response.json())
            .then((data) => {
                const filme = data;

                const linha = document.createElement("tr");

                const celulaId = document.createElement("td");
                celulaId.textContent = filme.id;
                linha.appendChild(celulaId);

                const celulaTitle = document.createElement("td");
                const linkTitle = document.createElement("a");
                linkTitle.textContent = filme.title;
                linkTitle.href = `3.1.detalhesFilme-Aluguel.html?id=${encodeURIComponent(filme.id)}`;
                celulaTitle.appendChild(linkTitle);
                linha.appendChild(celulaTitle);

                const celulaGenero = document.createElement("td");
                celulaGenero.textContent = filme.genero;
                linha.appendChild(celulaGenero);

                const celulaAno = document.createElement("td");
                celulaAno.textContent = filme.ano;
                linha.appendChild(celulaAno);

                const celulaEstoque = document.createElement("td");
                celulaEstoque.textContent = filme.quantidadeEstoque;
                linha.appendChild(celulaEstoque);

                const celulaExcludeBtn = document.createElement("td");
                const excludeBtn = document.createElement("button");
                excludeBtn.type = 'button';
                
                excludeBtn.id = 'exc-button';
                excludeBtn.classList.add('exclude-btn');
                const iconeLixeira = document.createElement('i');
                iconeLixeira.classList.add('fa-solid', 'fa-trash');
                excludeBtn.appendChild(iconeLixeira);
                excludeBtn.value = filme.id;
                celulaExcludeBtn.appendChild(excludeBtn);
                linha.appendChild(celulaExcludeBtn);

                const dadosTabela = document.getElementById("corpo_tabela_filmes_2");
                dadosTabela.appendChild(linha);
            })
            .catch(error => console.error('Erro ao buscar filmes:', error));
    });

    const corpoTabela = document.getElementById("corpo_tabela_filmes_2");
    corpoTabela.addEventListener('click', function(e) {
        // Daria pra adicionar closest('tr')) tbm
        if (e.target.matches('i')) {
            const button = e.target.closest('button');
            const row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
            const idExcluir=parseInt(button.value);
            console.log("id a ser excliudo: ",idExcluir);
            idsTratados = idsTratados.filter(n => n !== idExcluir);//Exclusão do id de filme após click na lixeira
            console.log("ids restantes: ",idsTratados);
        }
    });

    const container = document.getElementById("section-signup-rent");

    const inputPessoaAlugar = document.createElement('input');
    inputPessoaAlugar.type = 'text';
    inputPessoaAlugar.id = 'pessoaAluguel';
    inputPessoaAlugar.name = 'pessoaAluguel';
    inputPessoaAlugar.required = true;
    const label = document.createElement('label');
    label.htmlFor = 'pessoaAluguel';
    label.textContent = 'Empréstimo para: ';

    container.appendChild(label);
    container.appendChild(inputPessoaAlugar);

    // ====== TABELA DE PESSOAS ======

    // THEAD criado uma única vez, fora do fetch.
    const table = document.getElementById("table_busca_pessoas_alugueis");
    const tableHead = document.createElement('thead');
    const tableRow = document.createElement('tr');

    const thId = document.createElement('th');
    thId.textContent = "Código";
    tableRow.appendChild(thId);    

    const thNome = document.createElement('th');
    thNome.textContent = "Nome";
    tableRow.appendChild(thNome);        

    const thCpf = document.createElement('th');
    thCpf.textContent = "CPF";    
    tableRow.appendChild(thCpf);        

    const thActions = document.createElement('th');
    thActions.textContent = "Ações";
    tableRow.appendChild(thActions);        

    tableHead.appendChild(tableRow);
    table.appendChild(tableHead);

    // Criar UM ÚNICO <tbody>
    const corpoTabelaPessoas = document.createElement("tbody");
    corpoTabelaPessoas.id = 'tbody_busca_pessoas'; // id para limpeza posterior
    table.appendChild(corpoTabelaPessoas);

    // ALTERAÇÃO: função para buscar pessoas e preencher a tabela (em vez de buscar imediatamente com input vazio).
    function buscarPessoas(query) {
        // ALTERAÇÃO: limpar o corpo antes de nova busca
        corpoTabelaPessoas.replaceChildren();

        // Estado "carregando"
        const carregando = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 4;
        td.textContent = 'Carregando...';
        carregando.appendChild(td);
        corpoTabelaPessoas.appendChild(carregando);

        fetch(`http://localhost:8080/pessoa/buscar?name=${encodeURIComponent(query)}`)
            .then((response) => response.json())
            .then((data) => {
                // limpar estado "carregando"
                corpoTabelaPessoas.replaceChildren();

                const pessoas = data || [];
                if (pessoas.length === 0) {
                    const vazio = document.createElement('tr');
                    const tdVazio = document.createElement('td');
                    tdVazio.colSpan = 4;
                    tdVazio.textContent = 'Nenhum resultado';
                    vazio.appendChild(tdVazio);
                    corpoTabelaPessoas.appendChild(vazio);
                    return;
                }

                pessoas.forEach(pessoa => {
                    const linha = document.createElement("tr");

                    const celulaId = document.createElement("td");
                    celulaId.textContent = pessoa.id;
                    linha.appendChild(celulaId);

                    const celulaName = document.createElement("td");
                    celulaName.textContent = pessoa.name;
                    linha.appendChild(celulaName);

                    const celulaCpf = document.createElement("td");
                    celulaCpf.textContent = pessoa.cpf;
                    linha.appendChild(celulaCpf);

                    const celulaRadio = document.createElement("td");
                    const radio = document.createElement("input");
                    radio.type = 'radio';
                    radio.name = 'pessoaID'; // radios no mesmo grupo
                    radio.className = 'radio';
                    radio.value = pessoa.id;
                    celulaRadio.appendChild(radio);
                    linha.appendChild(celulaRadio);

                    corpoTabelaPessoas.appendChild(linha);
                });
            })
            .catch((err) => {
                corpoTabelaPessoas.replaceChildren();
                const erro = document.createElement('tr');
                const tdErro = document.createElement('td');
                tdErro.colSpan = 4;
                tdErro.textContent = 'Erro ao buscar pessoas';
                erro.appendChild(tdErro);
                corpoTabelaPessoas.appendChild(erro);
                console.error(err);
            });
    }

    // Debouce simples para evitar busca a cada tecla
    let debounceTimer = null;
    inputPessoaAlugar.addEventListener('input', () => {
        const q = inputPessoaAlugar.value.trim();
        // mínimo de 2 caracteres para buscar
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            if (q.length >= 2) {
                buscarPessoas(q);
            } else {
                // limpa resultados se apagar o termo
                corpoTabelaPessoas.replaceChildren();
            }
        }, 300);
    });

    //Ao voltar via histórico (bfcache), limpar SOMENTE o tbody (mantém thead).
    window.addEventListener('pageshow', (e) => {
        if (e.persisted) {
            document.getElementById('tbody_busca_pessoas')?.replaceChildren();
        }
    });

    let idPessoaSelecionada=0;
    corpoTabelaPessoas.addEventListener('change',function(event){
        if(event.target.matches('.radio')){
            const radio=event.target;
            idPessoaSelecionada=radio.value;
            console.log(idPessoaSelecionada);
        }
    });


    //CONSERTAR ERRO NO OVERLAY QUE SOME SOZINHO
    const confirmFloatBtn = document.getElementById("confirm-rent-btn");
    const confirmRentBtn = document.getElementById("btnSim");
    const closeConfirmRentBtn = document.getElementById("btnNao");
    const overlay= document.getElementById("overlay");
    const confirmBox=document.getElementById("confirmBox");

    confirmFloatBtn.addEventListener('click',function(event){
        overlay.classList.add('active');
        confirmBox.classList.add('active');
    });

    closeConfirmRentBtn.addEventListener('click',function(event){
        overlay.classList.remove('active'); 
        confirmBox.classList.remove('active'); 
    });

    //Click fora tambem faz a janela sumir
    overlay.addEventListener('click',function(event){
        if(!confirmBox.contains(event.target)){
            overlay.classList.remove('active');
            confirmBox.classList.remove('active');
        }
    });
    
    confirmRentBtn.addEventListener('click',function(event){
        // sessionStorage.setItem('pessoaSelecionada', idPessoaSelecionada);
        // sessionStorage.setItem('filmesSelecionados', idsTratados);
        const filmesFormatados = idsTratados.map(id =>({id: id}));
        let today = new Date();
        const year = String(today.getFullYear());
        let month = String(today.getMonth() + 1); 
        let day = today.getDate(); 
        if(day<10){
            day=String('0'+day);
        }
        if(month<10){
            month=String('0'+month);
        }
        today = year+'-'+month+'-'+day;
        console.log(idsTratados.length);
        let precoAluguel = 12*(idsTratados.length);
        const dataToSend = {
            valorAluguel: precoAluguel,
            dataAluguel: today,
            pessoa:{
                id: idPessoaSelecionada
            },
            filmes: filmesFormatados
        };

        const jsonRequisicao = JSON.stringify(dataToSend,null,2);

        fetch('http://localhost:8080/aluguel/criar',{
            method: 'POST',
            headers: {
                   'Content-Type': 'application/json' 
            },
            body:jsonRequisicao
        })    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Success:', data);
    }).then(alert("Empréstimo Feito com Sucesso!")).then(window.location.href='3.telaInicial.html')



    });


    </script>
</body>
</html>
